<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="style.css">

    <title>D3 Grouped Graphs</title>

    <script src="es5-shim.min.js"></script>
    <script src="d3.min.js"></script>
</head>

<body>
    <script type="text/javascript">
        function GraphsEditor(svg) {

            var svgDefs = svg.append("svg:defs");

            svgDefs.append('svg:marker')
                .attr('id', 'mark-end-arrow')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 7)
                .attr('markerHeight', 3.5)
                .attr('orient', 'auto')
                .append('svg:path')
                .attr('d', 'M 0,-5 L10,0 L 0,5');

            svgDefs.append('svg:circle')
                .attr('id', 'defs-node-io-unconnected')
                .attr("r", 4)
                .attr("fill", "#fff")
                .attr("stroke", "#ddd")
                .attr("stroke-width", "1");

            var svgG = svg.append("g")
                .attr("id", "svg-g");

            this.itemNodes = [];

            var graphsEditor = this;

            let nodeConfig = {
                title: "Import dataset from url",
                desc: "File or folder of JPG, PNG, ZIP, RAR. Example of long description.",
                inputs: [{
                    ioTypeID: 2
                }, {
                    ioTypeID: 3
                }],
                outputs: [{
                    ioTypeID: 1
                }, {
                    ioTypeID: 2
                }, {
                    ioTypeID: 3
                }]

            };


            this.itemNodes.push(new ItemNode(graphsEditor, svgG, nodeConfig, {}));
            this.itemNodes.push(new ItemNode(graphsEditor, svgG, nodeConfig, {}));


        }

        function ItemNode(graphsEditor, svgG, nodeConfig, initialPosition) {


            this.xDifference;
            this.yDifference;

            this.svgG = svgG;
            this.nodeConfig = nodeConfig;
            this.initialPosition = initialPosition;

            var self = this;

            self.dragstarted = function (d) {
                d3.select(this).raise().classed("active", true);

                let gCurrentPosition = self.getTranslation(d3.select(this).attr("transform"));

                let gPositionX = gCurrentPosition[0];
                self.xDifference = (d3.event.x - gPositionX);

                let gPositionY = gCurrentPosition[1];
                self.yDifference = (d3.event.y - gPositionY);
            };

            self.dragged = function (d) {
                d3.select(this)
                    .attr("transform", "translate(" + (d3.event.x - self.xDifference) + ", " + (d3.event.y - self.yDifference) +
                        ")");
            };

            self.dragend = function (d) {
                d3.select(this).classed("active", false);
                console.log("dragend");
            };

            self.getTranslation = function (transform) {

                // Create a dummy g for calculation purposes only. This will never
                // be appended to the DOM and will be discarded once this function 
                // returns.
                let g = document.createElementNS("http://www.w3.org/2000/svg", "g");

                // Set the transform attribute to the provided string value.
                g.setAttributeNS(null, "transform", transform);

                // consolidate the SVGTransformList containing all transformations
                // to a single SVGTransform of type SVG_TRANSFORM_MATRIX and get
                // its SVGMatrix. 
                let matrix = g.transform.baseVal.consolidate().matrix;

                // As per definition values e and f are the ones for the translation.
                return [matrix.e, matrix.f];
            };

            self.ioMouseOverHandler = function() {
                d3.select(this)
                .classed("node-io-mouseover", true);
            };

            self.ioMouseOutHandler = function() {
                d3.select(this)
                .classed("node-io-mouseover", false);                    
            };

            let nodeG = self.svgG.append("g")
                .attr("class", "box")
                .attr("transform", "translate(300, 30)");


            self.nodeDescFO = nodeG.append("foreignObject")
                .attr("x", 40)
                .attr("y", 30)
                .attr("width", 230)
                .attr("height", "100%")
                .append("xhtml:div");

            self.nodeDescFO.html(nodeConfig.desc);

            let nodeRect = nodeG.append("rect")
                .attr("width", 280)
                .attr("height", function(){
                    console.log("test ");
                    console.log(self.nodeDescFO.node().offsetHeight);
                    return self.nodeDescFO.node().offsetHeight + 50;
                })
                .attr("rx", 10)
                .attr("ry", 10)
                .attr("fill", "#fff")
                .attr("stroke", "#bbb");


            for (let i = 0; i < self.nodeConfig.inputs.length; i++) {

                let distanceBetweenNodeInputs = nodeRect.attr("width") / (self.nodeConfig.inputs.length + 1) * (i + 1);

                nodeG.append("circle")
                    .attr("class", "node-io-unconnected node-io-input")
                    .attr("r", 4)
                    .attr("cx", distanceBetweenNodeInputs)
                    .attr("cy", 0)
                    .on("mouseover", self.ioMouseOverHandler)
                    .on("mouseout", self.ioMouseOutHandler);
            }

            for (let i = 0; i < self.nodeConfig.outputs.length; i++) {

                let distanceBetweenNodeOutputs = nodeRect.attr("width") / (self.nodeConfig.outputs.length + 1) * (i + 1);

                nodeG.append("circle")
                    .attr("class", "node-io-unconnected node-io-input")
                    .attr("r", 4)
                    .attr("cx", distanceBetweenNodeOutputs)
                    .attr("cy", nodeRect.attr("height"));
            }

            let nodeTitle = nodeG.append("text")
                .attr("class", "node-title")
                .attr("x", 40)
                .attr("y", 20)
                .text(nodeConfig.title);    

            nodeG.call(d3.drag()
                .on("start", self.dragstarted)
                .on("drag", self.dragged)
                .on("end", self.dragend)
            );
        }


        d3.select("body")
            .append("h1")
            .text("A simple grouped draggable graphs");

        d3.select("h1")
            .on("click", function () {

                let marginLeft = d3.select(this).style("margin-left");
                let newMarginLeft = parseInt(marginLeft, 10) + 50;

                d3.select(this)
                    .transition()
                    .style("margin-left", newMarginLeft + "px");
                console.log("h1 clicked");
            });

        var svg = d3.select("body")
            .append("svg")
            .attr("id", "graphs-editor-container")
            .attr("width", 800)
            .attr("height", 600)
            .attr("style", "background: #f9f9f9");



        let graphsEditor = new GraphsEditor(svg);
    </script>

</body>

</html>