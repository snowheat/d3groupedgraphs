<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="style.css">

    <title>D3 Grouped Graphs</title>

    <script src="d3.min.js"></script>
</head>

<body>
    <script type="text/javascript">
        
        function GraphsEditor(svg) {

            var svgDefs = svg.append("svg:defs");

            svgDefs.append('svg:marker')
                .attr('id', 'mark-end-arrow')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 7)
                .attr('markerHeight', 3.5)
                .attr('orient', 'auto')
                .append('svg:path')
                .attr('d', 'M 0,-5 L10,0 L 0,5');

            var svgG = svg.append("g")
                .attr("id", "svg-g");

            var processBoxArray = [];

            let processBox1 = new ProcessBox(svgG, {}, {});

            let processBox2 = new ProcessBox(svgG, {}, {});

        }

        function ProcessBox(svgG, ioConfig, initialPosition) {

            console.log("uhuhuy");

            this.xDifference;
            this.yDifference;

            this.svgG = svgG;
            this.ioConfig = ioConfig;
            this.initialPosition = initialPosition;

            var self = this;

            self.dragstarted = function (d) {
                d3.select(this).raise().classed("active", true);

                let gCurrentPosition = self.getTranslation(d3.select(this).attr("transform"));

                let gPositionX = gCurrentPosition[0];
                self.xDifference = (d3.event.x - gPositionX);

                let gPositionY = gCurrentPosition[1];
                self.yDifference = (d3.event.y - gPositionY);
            };

            self.dragged = function (d) {
                d3.select(this)
                    .attr("transform", "translate(" + (d3.event.x - self.xDifference) + ", " + (d3.event.y - self.yDifference) +
                        ")");
            };

            self.dragend = function (d) {
                d3.select(this).classed("active", false);
                console.log("dragend");
            };

            self.getTranslation = function (transform) {

                // Create a dummy g for calculation purposes only. This will never
                // be appended to the DOM and will be discarded once this function 
                // returns.
                let g = document.createElementNS("http://www.w3.org/2000/svg", "g");

                // Set the transform attribute to the provided string value.
                g.setAttributeNS(null, "transform", transform);

                // consolidate the SVGTransformList containing all transformations
                // to a single SVGTransform of type SVG_TRANSFORM_MATRIX and get
                // its SVGMatrix. 
                let matrix = g.transform.baseVal.consolidate().matrix;

                // As per definition values e and f are the ones for the translation.
                return [matrix.e, matrix.f];
            };

            var boxG = self.svgG.append("g")
                .attr("class", "box")
                .attr("transform", "translate(30, 30)");

            boxG.append("rect")
                .attr("width", 150)
                .attr("height", 70)
                .attr("rx", 10)
                .attr("ry", 10)
                .attr("fill", "#fff")
                .attr("stroke", "#bbb");

            boxG.append("circle")
                .attr("r", 5)
                .attr("fill", "#666")
                .attr("cx", 75)
                .attr("cy", 70);

            boxG.call(d3.drag()
                .on("start", self.dragstarted)
                .on("drag", self.dragged)
                .on("end", self.dragend)
            );
        }


        d3.select("body")
            .append("h1")
            .text("A simple grouped draggable graphs");

        d3.select("h1")
            .on("click", function () {

                let marginLeft = d3.select(this).style("margin-left");
                let newMarginLeft = parseInt(marginLeft, 10) + 50;

                d3.select(this)
                    .transition()
                    .style("margin-left", newMarginLeft + "px");
                console.log("h1 clicked");
            });

        var svg = d3.select("body")
            .append("svg")
            .attr("id", "graphs-container")
            .attr("width", 800)
            .attr("height", 600)
            .attr("style", "background: #f9f9f9");

        let graphsEditor = new GraphsEditor(svg);
    </script>

</body>

</html>